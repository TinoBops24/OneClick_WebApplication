@page
@model OneClick_WebApp.Pages.Account.SetupPasswordModel
@{
    ViewData["Title"] = "Set Your Password";
}

<style>
    body {
       
        background: url('/images/Background.png') no-repeat center center fixed;
        background-size: cover;
    
        background: #f8f9fa;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-wrapper {
        min-height: calc(100vh - 60px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .setup-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 420px;
        width: 100%;
    }

    .welcome-message {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    h1 {
        font-weight: 700;
        margin-bottom: 1rem;
        color: #212529;
        text-align: center;
    }

    .form-floating > input {
        border-radius: 0.5rem;
        border: 1.5px solid #ced4da;
        transition: border-color 0.3s ease;
    }

        .form-floating > input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.3) !important;
        }

    .btn-primary {
        border-radius: 50px;
        font-weight: 600;
        padding: 0.6rem 0;
        font-size: 1.1rem;
    }

    .password-requirements {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }

    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }
</style>

<div class="page-wrapper">
    <div class="setup-container">
        <h1>@ViewData["Title"]</h1>

        <div class="welcome-message">
            <strong>Welcome back!</strong><br>
            We found your account in our system. Please set a password to continue accessing your account.
        </div>

        <div id="infoMessage" class="alert-info" style="display: none;"></div>
        <div id="warningMessage" class="alert-warning" style="display: none;"></div>

        <form id="setupPasswordForm" method="post" novalidate>
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

            <div class="form-floating mb-4">
                <input asp-for="Input.Email" class="form-control" readonly style="background-color: #f8f9fa;" />
                <label asp-for="Input.Email">Email Address</label>
            </div>

            <div class="form-floating mb-4">
                <input asp-for="Input.Password" type="password" class="form-control" autocomplete="new-password" placeholder="Password" aria-required="true" />
                <label asp-for="Input.Password">New Password</label>
                <span asp-validation-for="Input.Password" class="text-danger"></span>
                <div class="password-requirements">
                    Password must be at least 8 characters long and contain uppercase, lowercase, number, and special character.
                </div>
            </div>

            <div class="form-floating mb-4">
                <input asp-for="Input.ConfirmPassword" type="password" class="form-control" autocomplete="new-password" placeholder="Confirm Password" aria-required="true" />
                <label asp-for="Input.ConfirmPassword">Confirm Password</label>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>

            <button id="setupSubmit" type="submit" class="btn btn-primary w-100 mb-3">Set Password & Sign In</button>

            <input type="hidden" asp-for="Input.ErpUserId" />
        </form>

        <div class="text-center mt-3">
            <a href="/Account/Login" class="text-muted">Back to Login</a>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "@Model.Configuration["Firebase:ApiKey"]",
            authDomain: "@Model.Configuration["Firebase:AuthDomain"]",
            projectId: "@Model.Configuration["Firebase:ProjectId"]",
            storageBucket: "@Model.Configuration["Firebase:StorageBucket"]"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        function showInfo(message) {
            const infoDiv = document.getElementById('infoMessage');
            infoDiv.textContent = message;
            infoDiv.style.display = 'block';
            setTimeout(() => { infoDiv.style.display = 'none'; }, 5000);
        }

        function showWarning(message) {
            const warningDiv = document.getElementById('warningMessage');
            warningDiv.textContent = message;
            warningDiv.style.display = 'block';
        }

        document.getElementById('setupPasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('Input_Email').value;
            const password = document.getElementById('Input_Password').value;
            const confirmPassword = document.getElementById('Input_ConfirmPassword').value;
            const erpUserId = document.getElementById('Input_ErpUserId').value;
            const setupButton = document.getElementById('setupSubmit');

            // Client-side validation
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters long!');
                return;
            }

            setupButton.disabled = true;
            setupButton.innerText = 'Setting up...';

            try {
                console.log('Step 1: Linking ERP user with Firebase...');
                showInfo('Setting up your account...');

                // Call server to link ERP user with Firebase (this will update password if user exists)
                const linkResponse = await fetch('/Account/SetupPassword?handler=LinkErpUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        erpUserId: erpUserId
                    })
                });

                const responseText = await linkResponse.text();
                console.log('Link response:', responseText);

                if (!linkResponse.ok) {
                    throw new Error(responseText || 'Failed to link account');
                }

                const linkResult = JSON.parse(responseText);
                console.log('Link result parsed:', linkResult);

                if (!linkResult.success && !linkResult.canProceedToLogin) {
                    throw new Error(linkResult.message || 'Failed to link account');
                }

                showInfo('Account linked successfully! Signing you in...');
                console.log('Step 2: Attempting Firebase sign in with new password...');

                // Wait a moment for Firebase to sync the password update
                await new Promise(resolve => setTimeout(resolve, 1000));

                try {
                    // Now sign in with the password we just set
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const idToken = await userCredential.user.getIdToken();

                    console.log('Step 3: Firebase sign in successful, setting auth cookie...');
                    showInfo('Authentication successful! Redirecting...');

                    // Set auth cookie
                    const authResponse = await fetch('/Account/Login?handler=SetAuthCookie', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify({ idToken: idToken })
                    });

                    if (authResponse.ok) {
                        console.log('Auth cookie set successfully, redirecting to home page...');
                        window.location.href = '/';
                    } else {
                        throw new Error('Failed to set authentication cookie.');
                    }
                } catch (firebaseError) {
                    console.error('Firebase sign in error:', firebaseError);

                    if (firebaseError.code === 'auth/invalid-login-credentials' ||
                        firebaseError.code === 'auth/wrong-password' ||
                        firebaseError.code === 'auth/invalid-credential') {

                        // Password sync issue - provide clear guidance
                        showWarning('Account linked but sign-in failed. This can happen if there was a sync delay.');

                        setTimeout(() => {
                            alert('Your account has been successfully linked!\n\n' +
                                  'Please return to the login page and sign in with the password you just set.\n\n' +
                                  'If you continue to have issues, please use the "Forgot Password" option.');
                            window.location.href = '/Account/Login';
                        }, 2000);
                    } else if (firebaseError.code === 'auth/too-many-requests') {
                        showWarning('Too many attempts. Please wait a moment and try again.');
                        setTimeout(() => {
                            window.location.href = '/Account/Login';
                        }, 3000);
                    } else {
                        throw firebaseError;
                    }
                }

            } catch (error) {
                console.error('Setup error:', error);

                let errorMessage = 'An error occurred while setting up your account.';

                if (error.message) {
                    if (error.message.includes('already linked')) {
                        errorMessage = 'This account is already set up. Please use the login page.';
                        setTimeout(() => {
                            window.location.href = '/Account/Login';
                        }, 2000);
                    } else if (error.message.includes('Invalid user data')) {
                        errorMessage = 'Invalid user information. Please contact support.';
                    } else {
                        errorMessage = error.message;
                    }
                }

                showWarning(errorMessage);
                setupButton.disabled = false;
                setupButton.innerText = 'Set Password & Sign In';
            }
        });
    </script>
}