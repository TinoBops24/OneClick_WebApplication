@page
@model IndexModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@using System.Globalization
@{
    ViewData["Title"] = "Home";
}
<!-- This is the codefile I want you to fix -->
@section Preload {
    @if (Model.FeaturedProducts != null)
    {
        @foreach (var product in Model.FeaturedProducts.Take(4))
        {
            @if (!string.IsNullOrEmpty(product.ImageUrl))
            {
                <link rel="preload" as="image" href="@product.ImageUrl">
            }
        }
    }
}


<style>
    /* Notification container */
    .notification-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        width: 300px;
    }

    .hero-banner {
        position: relative;
        height: 90vh;
        margin-top: 10px;
        background: url('/images/pharmacist-banner.png') no-repeat center center !important;
        background-size: cover !important;
        border-radius: 0 0 2rem 2rem;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 2; /* Ensure it's above any background elements */
    }

    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.45);
    }

    .hero-content {
        position: relative;
        z-index: 1;
        max-width: 850px;
        color: #fff;
        padding: 0 15px;
    }

        .hero-content h1 {
            font-size: clamp(2rem, 5vw, 4rem); /* responsive heading */
        }

        .hero-content p {
            font-size: clamp(1rem, 2vw, 1.25rem); /* responsive text */
        }

        .hero-content .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            font-weight: 500;
        }

    /* Categories Section White Container */
    .categories-section {
        background-color: #ffffff;
        border-radius: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 2rem;
        margin: 2rem auto;
        max-width: 1400px;
    }

    /* Category Cards */
    .category-card .card {
        border-radius: 1rem;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .category-card:hover .card {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .category-card img {
        height: 160px;
        object-fit: cover;
    }

    /* Featured Products Section */
    .featured-products-section {
        background: linear-gradient(135deg, #ffffff 0%, #f0f6ff 100%);
        border-radius: 1.5rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        margin: 2rem auto;
        max-width: 1400px;
    }

    .featured-card {
        background-color: #FAFAFA;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .featured-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.18);
        }

        .featured-card img {
            border-radius: 1rem 1rem 0 0;
            height: 220px;
            object-fit: cover;
            border-bottom: 1px solid #eaeaea;
        }

        .featured-card .card-body,
        .featured-card .card-footer {
            background-color: #FAFAFA;
        }

    @@media (max-width: 768px) {
        .hero-banner {
            height: 70vh; /* smaller on mobile */
        }
    }
</style>

<div id="notification-container" class="notification-container"></div>

<!-- Hero Banner Section -->
<div class="hero-banner">
    <div class="hero-overlay"></div>
    <div class="hero-content text-center">
        <h1 class="fw-bold mb-4">Your Health, Our Priority</h1>
        <p class="lead fw-normal mb-5">From Essential Medicines To Wellness Products Delivered Safely To Your Door.</p>
        <a class="btn btn-primary btn-lg px-5 py-3 shadow" asp-page="/Products/Index">
            Explore Health Essentials
        </a>
    </div>
</div>

<!-- Shop by Category Section -->
@if (Model.CategoriesWithImages != null && Model.CategoriesWithImages.Any())
{
    <div class="categories-section">
        <div class="container px-4 px-lg-5">
            <h2 class="text-center mb-4">Shop by Category</h2>
            <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-6 justify-content-center">
                @foreach (var category in Model.CategoriesWithImages.OrderBy(c => c.Name))
                {
                    var imgUrl = string.IsNullOrEmpty(category.ImageUrl)
                    ? "https://placehold.co/400x300/EFEFEF/333333?text=" + category.Name.Substring(0, 1)
                    : category.ImageUrl;

                    <div class="col mb-5">
                        <a asp-page="/Products/Index" asp-route-categoryFilter="@category.Id" class="category-card text-decoration-none">
                            <div class="card h-100 shadow-sm">
                                <img class="card-img-top" src="@imgUrl" alt="@category.Name" loading="lazy" asp-append-version="true" />
                                <div class="card-footer p-3 pt-2 border-top-0 bg-transparent text-center">
                                    <h6 class="fw-bolder">@category.Name</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Featured Products Section -->
@if (Model.FeaturedProducts != null && Model.FeaturedProducts.Any())
{
    <div class="featured-products-section py-5">
        <div class="container px-4 px-lg-5">
            <h2 class="text-center mb-4">Featured Products</h2>
            <input type="hidden" name="__RequestVerificationToken" value="@(Antiforgery.GetAndStoreTokens(HttpContext).RequestToken)" />
            <div class="row gx-4 gx-lg-5 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
                @foreach (var product in Model.FeaturedProducts)
                {
                    <div class="col mb-5">
                        <div class="card featured-card h-100">
                            <img class="card-img-top"
                                 src="@(string.IsNullOrEmpty(product.ImageUrl) ? "https://placehold.co/450x300?text=No+Image" : product.ImageUrl)"
                                 alt="@product.Name"
                                 loading="lazy"
                                 asp-append-version="true"
                                 width="450"
                                 height="300" />

                            <div class="card-body p-4 text-center">
                                <h5 class="fw-bolder">@product.Name</h5>
                                <p class="text-primary fw-bold mb-0">
                                    @product.Price.ToString("C", new CultureInfo("en-ZA"))
                                </p>
                            </div>

                            <div class="card-footer p-4 pt-0 border-top-0 text-center">
                                @if (User.Identity?.IsAuthenticated ?? false)
                                {
                                    <button type="button" class="btn btn-outline-dark mt-auto add-to-cart-btn" data-product-id="@product.Id">Add to cart</button>
                                }
                                else
                                {
                                    <a class="btn btn-outline-primary mt-auto" href="/Account/Login?returnUrl=/">Login to buy</a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => { alertDiv.remove(); }, 4000);
        }

        async function handleHomepageAddToCart(button) {
            const productId = button.dataset.productId;
            const quantity = 1;
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            if (!token) {
                showNotification('Security error. Please refresh the page.', 'danger');
                return;
            }

            const formData = new URLSearchParams();
            formData.append('productId', productId);
            formData.append('quantity', quantity);

            try {
                const response = await fetch('?handler=AddToCartAjax', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                    body: formData.toString()
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok, status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    sessionStorage.setItem("cart", JSON.stringify(result.cart));
                    if (typeof refreshCartAndWishlistBadges === "function") {
                        refreshCartAndWishlistBadges();
                    }
                } else {
                    showNotification(result.message || 'An unknown error occurred.', 'danger');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                showNotification('Failed to add product to cart.', 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function () {
                    handleHomepageAddToCart(this);
                });
            });
        });
    </script>
}